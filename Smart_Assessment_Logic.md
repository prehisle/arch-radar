# 智能组卷逻辑说明文档

本文档详细说明了系统当前实现的智能组卷逻辑，包括会话管理、题目抽样策略、AI 题目生成及缓存机制。

## 1. 核心流程概述

智能组卷模块负责为每位用户生成一份包含 75 道单项选择题的模拟试卷。其核心流程如下：

1.  **会话检查**：优先检查 Redis 缓存，其次检查数据库，判断用户是否已有未完成的测评。
2.  **新卷生成**：若无活跃会话，则触发组卷算法。
    *   **题源分配**：按固定比例分配历年真题、章节练习题和 AI 变式题。
    *   **加权抽样**：基于知识点权重进行随机抽样。
    *   **AI 生成**：若 AI 题库不足，实时调用大模型生成新题。
3.  **持久化与缓存**：将生成的试卷存入数据库，并写入 Redis 缓存以支持快速访问和会话恢复。

## 2. 详细逻辑说明

### 2.1 会话保持与恢复机制

系统通过 `user_fingerprint`（用户指纹）唯一标识用户，并利用 Redis 实现高性能的会话保持。

*   **缓存优先 (Redis)**：
    *   用户发起请求时，首先查询 Redis 中的 `exam_session:{user_fingerprint}`。
    *   **命中缓存**：检查是否过期（逻辑有效期 150 分钟）。若有效，直接返回缓存数据（含试题和已答进度），无需查库。
    *   **未命中/过期**：进入数据库查询步骤。

*   **数据库兜底 (MySQL)**：
    *   查询 `exam_session` 表中是否存在 `is_submitted=False` 的记录。
    *   **存在有效记录**：
        *   更新用户的 IP、设备信息和地理位置。
        *   计算剩余时间（总时长 150 分钟 - 已过去时间）。
        *   若剩余时间 > 0，恢复会话，并将数据回写到 Redis 缓存（设置 30 分钟 TTL）。
        *   若剩余时间 <= 0，标记为已提交（过期）。

### 2.2 智能组卷算法

当需要生成新试卷时，系统遵循以下策略：

#### 2.2.1 题源配比
目标总题数：**75 题**。
*   **低权重/冷门题目**：预留 **2-3 题**。
    *   从知识点权重为“一般”、“冷门”或“非考纲要求”的题目中随机抽取。
    *   目的：模拟真实考试中出现的少量非重点或超纲题。
*   **剩余题目分配**：
    *   **历年真题**：约 **22 题** (占比 ~30%)。
    *   **章节练习**：约 **37 题** (占比 ~50%)。
    *   **AI 变式题**：约 **13-15 题** (占比 ~20%)。

#### 2.2.2 加权随机抽样 (Weighted Random Sampling)
除冷门题目外，其余题目均采用**加权随机抽样**算法（Efraimidis-Spirakis 算法）。
*   **权重来源**：`knowledge_point` 表中的 `weight_score`。
*   **逻辑**：权重越高的知识点，其关联题目被抽中的概率越大。这确保了试卷重点突出，符合考纲要求。

#### 2.2.3 AI 题目实时生成
当数据库中 `source_type='ai_generated'` 的题目数量不足以满足配比（< 13 题）时，系统会触发实时生成逻辑：
1.  **种子题选择**：从历年真题和章节练习中随机选取 3 道作为“种子”。
2.  **大模型调用**：调用配置的 AI 模型（Gemini 或 Qwen），要求其基于种子题生成“考察相同知识点但题干和选项不同”的变式题。
3.  **质量校验**：
    *   检查题干、解析长度。
    *   验证选项完整性（必须是列表且长度 >= 2）。
    *   过滤包含无效字符（如 "xxx"）的生成结果。
4.  **入库**：校验通过的题目存入 `question` 表，标记为 `ai_generated`，并在本次组卷中优先使用。

### 2.3 答案同步与缓存更新

*   **实时同步**：前端定期调用 `/api/exam/sync` 接口上传用户答案。
*   **双写更新**：
    *   **数据库**：更新 `exam_session` 表的 `user_answers` 字段。
    *   **Redis**：同步更新缓存中的 `user_answers`，确保用户刷新页面后进度不丢失。

### 2.4 提交与缓存清理

*   **提交处理**：用户提交试卷后，系统进行判分并生成 AI 报告。
*   **缓存清除**：**立即删除** Redis 中的 `exam_session:{user_fingerprint}` 键。
*   **效果**：用户下次点击“开始测评”时，由于缓存已清除且数据库中最近一次会话已标记为提交，系统将自动触发新一轮的智能组卷。

## 3. 数据流向图

```mermaid
graph TD
    User[用户请求] --> API[开始测评接口]
    API --> Redis{Redis缓存存在?}
    Redis -- Yes --> CheckTime{时间未耗尽?}
    CheckTime -- Yes --> ReturnCache[返回缓存试卷]
    CheckTime -- No --> Expire[标记过期/删除缓存]
    Redis -- No --> DB{数据库有活跃会话?}
    
    DB -- Yes --> CheckDBTime{时间未耗尽?}
    CheckDBTime -- Yes --> Restore[恢复会话]
    Restore --> WriteRedis[回写Redis]
    WriteRedis --> ReturnDB[返回试卷数据]
    
    DB -- No --> NewExam[触发新组卷]
    NewExam --> SampleLow[抽取冷门题 (2-3题)]
    SampleLow --> SamplePast[加权抽取真题 (~22题)]
    SamplePast --> SampleEx[加权抽取练习题 (~37题)]
    SampleEx --> CheckAI{AI题库充足?}
    
    CheckAI -- No --> GenAI[调用大模型生成变式题]
    GenAI --> SaveAI[保存新题入库]
    SaveAI --> SampleAI
    CheckAI -- Yes --> SampleAI[加权抽取AI题 (~13题)]
    
    SampleAI --> Shuffle[题目混淆排序]
    Shuffle --> SaveSession[创建会话记录]
    SaveSession --> WriteRedisNew[写入Redis缓存]
    WriteRedisNew --> ReturnNew[返回新试卷]
```
