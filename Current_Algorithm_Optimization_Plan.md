# 现有智能组卷算法优化方案 (基于当前架构)

本文档基于系统当前已实现的 **“静态权重 + 分层抽样 + 实时AI生成”** 架构，提出针对性的、可快速落地的优化方案。旨在不进行大规模重构的前提下，显著提升组卷的个性化程度和系统性能。

## 1. 现状诊断

### 1.1 当前逻辑核心
*   **触发机制**：无活跃会话时触发。
*   **抽样策略**：
    *   **分层**：固定比例（真题 30% / 练习 50% / AI 20%）。
    *   **加权**：基于知识点预设的 `weight_score` 进行 `Efraimidis-Spirakis` 加权随机抽样。
*   **AI 策略**：当数据库中 AI 题量不足时，**同步阻塞**调用大模型生成。

### 1.2 存在的问题
1.  **个性化不足**：所有用户的抽样权重仅依赖知识点的“全局重要性”，未考虑用户个人的“历史掌握情况”。即：学霸和学渣刷到的题分布是一样的。
2.  **题目重复风险**：虽然有随机性，但对于高频刷题用户，缺乏“已做题目过滤”或“错题复现”机制，可能反复刷到已熟练掌握的旧题。
3.  **性能瓶颈**：AI 题目生成是**同步阻塞 (Blocking)** 的。一旦触发生成（需生成 3-10 道题），用户等待时间可能超过 10-20 秒，严重影响体验。
4.  **难度不可控**：仅控制了知识点分布，未控制难度分布（如：可能随机出一张全由简单题组成的试卷）。

---

## 2. 优化方案详情

### 2.1 优化一：引入“用户错题权重因子” (个性化加权)

**目标**：让用户更容易刷到自己薄弱的知识点。

**实现逻辑**：
在构建 `kp_weights` 字典时，不再仅使用全局 `weight_score`，而是结合用户的历史答题数据进行动态调整。

*   **原公式**：$W_{final} = W_{global}$
*   **新公式**：$W_{final} = W_{global} \times (1 + \alpha \times ErrorRate_{user})$
    *   $\alpha$：调节系数（例如 2.0）。
    *   $ErrorRate_{user}$：用户在该知识点的历史错误率（0~1）。

**代码落地思路**：
1.  在 `start_exam` 前，先聚合查询该用户 (`user_fingerprint`) 在 `exam_session` 中各知识点的答题统计。
2.  计算每个知识点的错误率。
3.  动态调整 `kp_weights` 字典的值。

### 2.2 优化二：实施“滑动窗口去重”策略

**目标**：避免用户短时间内刷到重复题目，保持新鲜感。

**实现逻辑**：
1.  **记录**：Redis 中维护一个 `user_history:{fingerprint}` 的 List，存储最近做过的 200 道题 ID。
2.  **过滤**：在从数据库获取候选题目池（`q_past`, `q_exercise`）后，先计算 `CandidateSet - HistorySet`。
3.  **回退**：如果过滤后题目数量不足，再从 HistorySet 中最早的题目开始回补。

### 2.3 优化三：基于错题驱动的 AI 题目定向生成

**目标**：将 AI 算力集中在用户的痛点上，实现“哪里不会练哪里”。

**实现逻辑**：
不再盲目预充通用题库，而是结合 **优化一 (2.1)** 的错题分析结果，进行针对性的 AI 题目生成。

1.  **冷启动场景 (第1次测评 / 无错题记录)**：
    *   **策略**：系统根据考纲权重的 Top 10 核心知识点，**随机选择**并生成 AI 变式题。
    *   **目的**：确保新用户首次测评时，试卷中包含一定比例的新颖题目，同时覆盖核心考点。

2.  **错题驱动场景 (后续测评)**：
    *   **策略**：
        1.  **识别痛点**：根据 2.1 识别出的用户“高频错题知识点”列表。
        2.  **库存检查**：检查题库中这些知识点下的 AI 变式题存量。
        3.  **定向生成**：若存量不足，则触发生成任务，要求 AI 基于该知识点的真题生成“孪生变式题”。
    *   **执行方式**：
        *   **同步生成**：若识别到高频错题知识点下缺乏 AI 变式题，则**实时调用**大模型生成 1-3 道题目。
        *   **超时控制**：设置严格的超时时间（如 50 秒），若 AI 响应超时，则自动降级使用该知识点的普通练习题，确保组卷流程不被长时间卡死。

---

## 3. 实施优先级建议

| 优先级 | 优化项 | 实施难度 | 收益 | 原因 |
| :--- | :--- | :--- | :--- | :--- |
| **P0** | **用户错题权重因子** | 中 | 高 | 智能组卷的核心，直接决定了“个性化”的程度。 |
| **P1** | **错题驱动的AI生成** | 中 | 高 | 解决“题荒”问题，同时确保 AI 生成的题目是用户最需要的。 |
| **P2** | **滑动窗口去重** | 低 | 中 | 防止刷题疲劳，提升内容丰富度。 |

## 4. 预期效果对比

| 指标 | 优化前 (现状) | 优化后 |
| :--- | :--- | :--- |
| **组卷耗时** | 不稳定 (可能阻塞) | **1s - 5s (视AI生成情况，有超时熔断)** |
| **AI 生成策略** | 盲目补充数量 | **精准打击痛点 (错题驱动)** |
| **薄弱点覆盖** | 随机覆盖 | **重点覆盖 + 变式强化** |
| **体验感** | 等待久、题目同质化 | **越做越懂我、针对性强** |
