name: Build and Push Docker Images

# è§¦å‘æ¡ä»¶ï¼š
# 1. Push åˆ° main åˆ†æ”¯ - æ„å»ºå¹¶æ¨é€ latest å’Œ sha-xxx æ ‡ç­¾
# 2. åˆ›å»º Git tag (v*.*.*) - æ„å»ºå¹¶æ¨é€ç‰ˆæœ¬æ ‡ç­¾
# 3. Pull Request - ä»…æ„å»ºéªŒè¯ï¼Œä¸æ¨é€é•œåƒ
on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

# å·¥ä½œæµæƒé™ï¼š
# - contents:read: è¯»å–ä»“åº“ä»£ç 
# - packages:write: æ¨é€é•œåƒåˆ° GitHub Container Registry
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest

    # ä½¿ç”¨ matrix ç­–ç•¥å¹¶è¡Œæ„å»º backend å’Œ frontend
    strategy:
      fail-fast: false  # ä¸€ä¸ªæ„å»ºå¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
      matrix:
        include:
          - service: backend
            dockerfile: docker/Dockerfile.backend
            context: .
          - service: frontend
            dockerfile: docker/Dockerfile.frontend
            context: .

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½•åˆ° GitHub Container Registry
      #    æ³¨æ„ï¼šPR ä¸éœ€è¦ç™»å½•ï¼ˆä¸æ¨é€ï¼‰
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. ç”Ÿæˆ Docker é•œåƒçš„ tags å’Œ labels
      #    - main åˆ†æ”¯ï¼šlatest + sha-<commit>
      #    - Git tagï¼šv1.0.0ï¼ˆä¿ç•™ v å‰ç¼€ï¼‰
      #    - PRï¼šä¸æ¨é€
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/arch-radar-${{ matrix.service }}
          tags: |
            # main åˆ†æ”¯æ¨é€æ—¶ç”Ÿæˆ latest æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}
            # main åˆ†æ”¯æ¨é€æ—¶ç”Ÿæˆ sha-<commit> æ ‡ç­¾ï¼ˆç”¨äºç²¾ç¡®å›æ»šï¼‰
            type=sha,prefix=sha-,enable={{is_default_branch}}
            # Git tag æ¨é€æ—¶ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼Œä¿ç•™ v å‰ç¼€ï¼‰
            type=ref,event=tag
          labels: |
            org.opencontainers.image.title=arch-radar-${{ matrix.service }}
            org.opencontainers.image.description=Intelligent exam preparation system - ${{ matrix.service }}
            org.opencontainers.image.vendor=arch-radar

      # 5. æ„å»º Docker é•œåƒï¼ˆPR æ—¶åªæ„å»ºï¼Œé PR æ—¶æ„å»ºå¹¶æ¨é€ï¼‰
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          # PR ä¸æ¨é€ï¼Œå…¶ä»–æƒ…å†µæ¨é€
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ„å»ºå‚æ•°
          build-args: |
            VITE_API_BASE_URL=/
            VITE_ADMIN_PATH=${{ secrets.ADMIN_PATH || '/admin-secret' }}

      # 6. è¾“å‡ºé•œåƒæ‘˜è¦å’Œæ ‡ç­¾ï¼ˆç”¨äºéªŒè¯å’Œè¿½è¸ªï¼‰
      - name: Output image digest and tags
        if: github.event_name != 'pull_request'
        run: |
          echo "âœ… Image built successfully!"
          echo ""
          echo "ğŸ“¦ Image digest:"
          echo "${{ steps.build.outputs.digest }}"
          echo ""
          echo "ğŸ·ï¸ Image tags:"
          echo "${{ steps.meta.outputs.tags }}"

  # å¯é€‰ï¼šé•œåƒæ‰«æä»»åŠ¡ï¼ˆæ¨èåœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼‰
  # æ³¨æ„ï¼šå¦‚éœ€å¯ç”¨ï¼Œéœ€è¦æ·»åŠ æƒé™ security-events: write
  #
  # security-scan:
  #   name: Security Scan (${{ matrix.service }})
  #   needs: build-and-push
  #   runs-on: ubuntu-latest
  #   if: github.event_name != 'pull_request'
  #   permissions:
  #     security-events: write
  #
  #   strategy:
  #     matrix:
  #       service: [backend, frontend]
  #
  #   steps:
  #     - name: Run Trivy vulnerability scanner
  #       uses: aquasecurity/trivy-action@0.24.0  # ä½¿ç”¨å›ºå®šç‰ˆæœ¬è€Œé master
  #       with:
  #         # æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥æ‰«æåˆšæ„å»ºçš„ digestï¼Œè€Œä¸æ˜¯ latest
  #         # å®é™…ä½¿ç”¨æ—¶éœ€è¦ä» build-and-push job ä¼ é€’ digest
  #         image-ref: ghcr.io/${{ github.repository_owner }}/arch-radar-${{ matrix.service }}@${{ needs.build-and-push.outputs.digest }}
  #         format: 'sarif'
  #         output: 'trivy-results.sarif'
  #
  #     - name: Upload Trivy results to GitHub Security tab
  #       uses: github/codeql-action/upload-sarif@v3
  #       with:
  #         sarif_file: 'trivy-results.sarif'
